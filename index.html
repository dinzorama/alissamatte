<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matte√∂vning</title>
  <style>
    :root{
      --bg:#f7fafc;
      --card:#ffffff;
      --ink:#1a202c;
      --muted:#4a5568;
      --brand:#2563eb;
      --right:#16a34a;
      --wrong:#dc2626;
      --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg); color:var(--ink);
      display:flex; min-height:100svh; align-items:center; justify-content:center; padding:24px;
    }
    .app{width:min(960px,100%);}
    header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
    h1{font-size:clamp(22px,3vw,32px); margin:0}
    .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px}
    .controls{display:grid; grid-template-columns:1fr; gap:12px}
    @media (min-width:740px){
      .controls{grid-template-columns: 1.3fr 1.2fr 1fr}
    }
    fieldset{border:0; padding:0; margin:0}
    legend{font-weight:600; margin-bottom:8px}
    .row{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    label{display:flex; align-items:center; gap:8px; padding:8px 10px; background:#f1f5f9; border-radius:12px; cursor:pointer}
    select, input[type="number"], input[type="text"]{padding:10px 12px; border-radius:12px; border:1px solid #e2e8f0; font-size:16px; width:100%;}
    button{appearance:none; border:0; background:var(--brand); color:white; padding:12px 16px; border-radius:14px; font-weight:700; cursor:pointer; box-shadow:var(--shadow);}
    button.secondary{background:#e2e8f0; color:#111827}
    button:disabled{opacity:.5; cursor:not-allowed}

    .play{margin-top:16px; display:grid; grid-template-columns:1fr; gap:16px; align-items:start}
    @media (min-width:740px){
      .play{grid-template-columns:1.1fr .9fr}
    }
    .problem{display:flex; flex-direction:column; gap:12px}
    .problem .q{font-size:clamp(28px,5vw,48px); font-weight:800; text-align:center}
    .answer{display:flex; gap:10px}
    .answer input{flex:1; text-align:center; font-weight:700; font-size:20px}

    .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
    .stat{background:#f8fafc; border-radius:14px; padding:12px}
    .stat .label{font-size:12px; color:var(--muted)}
    .stat .value{font-size:22px; font-weight:800}

    .progress{height:12px; background:#e5e7eb; border-radius:999px; overflow:hidden}
    .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--brand), #06b6d4); transition:width .25s ease}

    .feedback{min-height:28px; font-weight:700}
    .feedback.ok{color:var(--right)}
    .feedback.no{color:var(--wrong)}

    .timer{font-variant-numeric:tabular-nums; font-weight:800}

    .tiny{font-size:12px; color:var(--muted)}

    /* konfetti */
    .confetti{position:fixed; inset:0; pointer-events:none; overflow:hidden}
    .confetti i{position:absolute; width:10px; height:14px; opacity:0; transform:translateY(-20px) rotate(0deg); border-radius:3px}
    @keyframes pop{to{transform:translateY(100vh) rotate(720deg); opacity:1}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Matte√∂vning</h1>
      <div class="tiny">Allt k√∂rs lokalt i din webbl√§sare</div>
    </header>
    <section class="card controls">
      <fieldset>
        <legend>R√§knes√§tt</legend>
        <div class="row">
          <label><input type="checkbox" id="opAdd" checked> Addition (+)</label>
          <label><input type="checkbox" id="opSub" checked> Subtraktion (‚àí)</label>
          <label><input type="checkbox" id="opMul" checked> Multiplikation (√ó)</label>
        </div>
      </fieldset>
      <fieldset>
        <legend>Sv√•righetsgrad</legend>
        <div class="row">
          <select id="difficulty">
            <option value="easy">L√§tt (0‚Äì10)</option>
            <option value="medium" selected>Medel (0‚Äì20)</option>
            <option value="hard">Sv√•r (0‚Äì99)</option>
          </select>
          <select id="timesTable">
            <option value="mix" selected>Tabell: Blanda</option>
            <option value="1">Tabell 1</option>
            <option value="2">Tabell 2</option>
            <option value="3">Tabell 3</option>
            <option value="4">Tabell 4</option>
            <option value="5">Tabell 5</option>
            <option value="6">Tabell 6</option>
            <option value="7">Tabell 7</option>
            <option value="8">Tabell 8</option>
            <option value="9">Tabell 9</option>
            <option value="10">Tabell 10</option>
            <option value="11">Tabell 11</option>
            <option value="12">Tabell 12</option>
          </select>
        </div>
        <div class="tiny">Tips: V√§lj en specifik tabell om du vill fokusera p√• multiplikationstabeller.</div>
      </fieldset>
      <fieldset>
        <legend>L√§ge</legend>
        <div class="row">
          <select id="mode">
            <option value="practice" selected>√ñva (lugnt tempo)</option>
            <option value="challenge">Snabb utmaning (timer)</option>
          </select>
          <select id="duration">
            <option value="30">30 sek</option>
            <option value="60" selected>60 sek</option>
            <option value="120">120 sek</option>
          </select>
          <button id="startBtn">Starta</button>
          <button id="stopBtn" class="secondary" disabled>Stoppa</button>
        </div>
      </fieldset>
    </section>

    <section class="play">
      <div class="card problem">
        <div class="q" id="question">Klicka p√• Starta f√∂r att b√∂rja</div>
        <div class="answer">
          <input id="answer" type="number" inputmode="numeric" placeholder="Skriv svaret h√§r" disabled />
          <button id="submitBtn" disabled>Svara</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="progress"><div class="bar" id="progBar"></div></div>
      </div>

      <div class="card">
        <div class="stats">
          <div class="stat"><div class="label">Po√§ng</div><div class="value" id="score">0</div></div>
          <div class="stat"><div class="label">R√§tt i rad</div><div class="value" id="streak">0</div></div>
          <div class="stat"><div class="label">Fr√•gor</div><div class="value" id="count">0</div></div>
          <div class="stat"><div class="label">Tid</div><div class="value timer" id="time">‚Äì</div></div>
        </div>
        <div class="tiny" style="margin-top:8px">H√∂gsta po√§ng (utmaning): <span id="highscore">0</span></div>
      </div>
    </section>
  </div>
  <div class="confetti" id="confetti"></div>

  <script>
  ;(() => {
    const ui = {
      opAdd: document.getElementById('opAdd'),
      opSub: document.getElementById('opSub'),
      opMul: document.getElementById('opMul'),
      difficulty: document.getElementById('difficulty'),
      timesTable: document.getElementById('timesTable'),
      mode: document.getElementById('mode'),
      duration: document.getElementById('duration'),
      startBtn: document.getElementById('startBtn'),
      stopBtn: document.getElementById('stopBtn'),
      question: document.getElementById('question'),
      answer: document.getElementById('answer'),
      submitBtn: document.getElementById('submitBtn'),
      feedback: document.getElementById('feedback'),
      progBar: document.getElementById('progBar'),
      score: document.getElementById('score'),
      streak: document.getElementById('streak'),
      count: document.getElementById('count'),
      time: document.getElementById('time'),
      confetti: document.getElementById('confetti'),
      highscore: document.getElementById('highscore'),
    }

    const state = {
      playing:false,
      challenge:false,
      remaining:0,
      timerId:null,
      score:0,
      streak:0,
      count:0,
      a:0, b:0, op:'+', ans:0,
    }

    // Ljud (Web Audio) ‚Äì inga filer kr√§vs
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)()
    function beep(freq=880, dur=120){
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.type = 'sine'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
      g.gain.setValueAtTime(0.001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.3, audioCtx.currentTime + 0.01);
      o.start();
      g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + dur/1000);
      o.stop(audioCtx.currentTime + dur/1000);
    }
    function rightSound(){beep(1046,120); setTimeout(()=>beep(1318,150),80)}
    function wrongSound(){beep(196,160)}

    // Konfetti ‚Äì enkel, performant
    function popConfetti(){
      const n = 80;
      const colors = ['#60a5fa','#34d399','#fbbf24','#f472b6','#93c5fd','#fdba74'];
      for(let i=0;i<n;i++){
        const el = document.createElement('i');
        el.style.left = Math.random()*100+'vw';
        el.style.background = colors[Math.random()*colors.length|0];
        el.style.animation = `pop ${800 + Math.random()*900}ms ease-out forwards`;
        el.style.transform = `translateY(-10px) rotate(${Math.random()*360}deg)`;
        el.style.opacity = .9;
        ui.confetti.appendChild(el);
        setTimeout(()=> el.remove(), 1800);
      }
    }

    function randInt(min,max){return Math.floor(Math.random()*(max-min+1))+min}

    function ranges(){
      const d = ui.difficulty.value;
      if(d==='easy') return [0,10]
      if(d==='medium') return [0,20]
      return [0,99]
    }

    function chooseOp(){
      const ops = []
      if(ui.opAdd.checked) ops.push('+')
      if(ui.opSub.checked) ops.push('‚àí')
      if(ui.opMul.checked) ops.push('√ó')
      if(ops.length===0){ ops.push('+') }
      // Om specifik tabell valts, prioritera multiplikation
      if(ui.timesTable.value!== 'mix') return '√ó'
      return ops[Math.random()*ops.length|0]
    }

    function nextProblem(){
      const [min,max] = ranges();
      let a=0,b=0,op=chooseOp(), ans=0

      if(op==='√ó'){
        const tbl = ui.timesTable.value
        if(tbl==='mix'){
          a = randInt(min, max>12?12:max)
        } else {
          a = parseInt(tbl,10)
        }
        b = randInt(0, 12)
        ans = a*b
      } else if(op==='‚àí'){
        a = randInt(min,max); b = randInt(min,max)
        if(b>a) [a,b]=[b,a] // undvik negativa
        ans = a-b
      } else { // +
        a = randInt(min,max); b = randInt(min,max)
        ans = a+b
      }
      state.a=a; state.b=b; state.op=op; state.ans=ans
      ui.question.textContent = `${a} ${op} ${b} = ?`
      ui.answer.value = ''
      ui.answer.focus()
    }

    function updateStats(){
      ui.score.textContent = state.score
      ui.streak.textContent = state.streak
      ui.count.textContent = state.count
      if(state.challenge){
        const total = parseInt(ui.duration.value,10)
        const gone = total - state.remaining
        const pct = Math.max(0, Math.min(100, (gone/total)*100))
        ui.progBar.style.width = pct + '%'
      } else {
        // anv√§nd streak som en liten progress-k√§nsla upp till 10
        const pct = Math.min(100, (state.streak/10)*100)
        ui.progBar.style.width = pct + '%'
      }
    }

    function showFeedback(ok, correctAns){
      ui.feedback.className = 'feedback ' + (ok? 'ok':'no')
      ui.feedback.textContent = ok ? 'R√§tt! Bra jobbat! üéâ' : `Inte riktigt. R√§tt svar √§r ${correctAns}. F√∂rs√∂k igen!`
    }

    function checkAnswer(){
      if(!state.playing) return
      const val = Number(ui.answer.value)
      const ok = (val === state.ans)
      state.count++
      if(ok){
        state.score += 10
        state.streak++
        showFeedback(true)
        rightSound()
        popConfetti()
        nextProblem()
      } else {
        state.streak = 0
        showFeedback(false, state.ans)
        wrongSound()
        // l√•t samma uppgift st√• kvar, uppmuntra f√∂rs√∂k igen
      }
      updateStats()
    }

    function setPlaying(on){
      state.playing = on
      ui.answer.disabled = !on
      ui.submitBtn.disabled = !on
      ui.stopBtn.disabled = !on
      ui.startBtn.disabled = on
      if(!on){ ui.progBar.style.width = '0%'; ui.time.textContent='‚Äì' }
    }

    function startPractice(){
      state.challenge = false
      state.score=0; state.streak=0; state.count=0
      ui.feedback.textContent = ''
      setPlaying(true)
      nextProblem(); updateStats()
    }

    function startChallenge(){
      state.challenge = true
      state.score=0; state.streak=0; state.count=0
      state.remaining = parseInt(ui.duration.value,10)
      ui.feedback.textContent = ''
      setPlaying(true)
      nextProblem(); updateStats()
      tick()
    }

    function tick(){
      if(!state.playing || !state.challenge) return
      ui.time.textContent = state.remaining + ' s'
      if(state.remaining<=0){
        endChallenge()
        return
      }
      state.remaining--
      updateStats()
      state.timerId = setTimeout(tick, 1000)
    }

    function endChallenge(){
      clearTimeout(state.timerId)
      state.timerId=null
      setPlaying(false)
      ui.question.textContent = 'Tiden √§r slut!'
      ui.feedback.textContent = `Du fick ${state.score} po√§ng p√• ${ui.duration.value} sekunder.`
      // spara highscore
      const key = 'matte_highscore_' + ui.duration.value
      const best = parseInt(localStorage.getItem(key)||'0',10)
      if(state.score>best){
        localStorage.setItem(key, String(state.score))
      }
      refreshHighscore()
    }

    function refreshHighscore(){
      const key = 'matte_highscore_' + ui.duration.value
      const best = parseInt(localStorage.getItem(key)||'0',10)
      ui.highscore.textContent = best
    }

    function stopAll(){
      clearTimeout(state.timerId); state.timerId=null
      setPlaying(false)
      ui.question.textContent = 'Klicka p√• Starta f√∂r att b√∂rja'
      ui.feedback.textContent = ''
    }

    // Events
    ui.startBtn.addEventListener('click', ()=>{
      (ui.mode.value==='challenge') ? startChallenge() : startPractice()
    })
    ui.stopBtn.addEventListener('click', stopAll)
    ui.submitBtn.addEventListener('click', checkAnswer)
    ui.answer.addEventListener('keydown', (e)=>{
      if(e.key==='Enter') checkAnswer()
    })
    ui.mode.addEventListener('change', ()=>{
      document.querySelector('label[for="duration"]')
      refreshHighscore();
    })
    ui.duration.addEventListener('change', refreshHighscore)

    // Init
    refreshHighscore()
  })()
  </script>
</body>
</html>